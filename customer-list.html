<div th:fragment="content">

  <div class="mb-4">
    <h2 class="fw-bold">Customer Lists</h2>
  </div>

  <!-- ===================== Search Card ===================== -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <form id="searchForm" class="row g-3">

        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label">Customer ID</label>
            <input id="txtCif" type="text" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Client</label>
            <select id="ddlJobStatus" class="form-select">
              <option value="">-- All --</option>
              <option value="PRMF">บริษัท พรอมิส (ประเทศไทย) จำกัด</option>
              <option value="AMNF">บริษัท ไอร่า แอนด์ ไอฟุล จำกัด (มหาชน)</option>
              <option value="KBAF">ธนาคารกสิกรไทย จำกัด มหาชน</option>
              <option value="BMW1">บริษัท บีเอ็มดับเบิลยู ลิสซิ่ง (ประเทศไทย) จำกัด</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Agreement No.</label>
            <input id="txtCif" type="text" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Address</label>
            <input id="txtCif" type="text" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Created Date From</label>
            <input id="txtCustName" type="date" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Created Date To</label>
            <input id="txtCif" type="date" class="form-control" placeholder="">
          </div>
        </div>

        <div class="row g-3 mt-0">
          <div class="col-md-2">
            <label class="form-label">Customer Name</label>
            <input id="txtCif" type="text" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Survey Type</label>
            <select id="ddlJobStatus" class="form-select">
              <option value="">-- All --</option>
              <option value="SUH">SUH : Survey at Home</option>
              <option value="SUC">SUC : Survey at Company</option>
              <option value="SUO">SUO : Survey at Other</option>
              <option value="GMH">GMH : Get Money at Home</option>
              <option value="GMC">GMC : Get Money at Company</option>
              <option value="GMO">GMO : Get Money at Other</option>
              <option value="GPH">GPH : Get Motorcycle at Home</option>
              <option value="GPC">GPC : Get Motorcycle at Company</option>
              <option value="GPO">GPO : Get Motorcycle at Other</option>
              <option value="GDH">GDH : Get Document at Home</option>
              <option value="GDC">GDC : Get Document at Company</option>
              <option value="GPH">GDO : Get Document at Other</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Job Status</label>
            <select id="ddlJobStatus" class="form-select">
              <option value="">-- All --</option>
              <option value="1">Draft</option>
              <option value="2">Sending</option>
              <option value="4">On process</option>
              <option value="5">Send PDA</option>
              <option value="6">Completed</option>
              <option value="98">MCI Cancel</option>
              <option value="99">Cancel</option>
            </select>
          </div>



          <div class="col-md-2">
            <label class="form-label">Zipcode</label>
            <input id="txtCustName" type="text" class="form-control" placeholder="">
          </div>



          <div class="col-md-2">
            <label class="form-label">Update Date From</label>
            <input id="txtCustName" type="date" class="form-control" placeholder="">
          </div>

          <div class="col-md-2">
            <label class="form-label">Update Date To</label>
            <input id="txtCif" type="date" class="form-control" placeholder="">
          </div>
        </div>

        <div class="col-12 d-flex gap-2 justify-content-center">
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-magnifying-glass me-2"></i>Search
          </button>

          <button id="btnReset" type="button" class="btn btn-outline-secondary">
            <i class="fa-solid fa-rotate-left me-2"></i>Clear
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- ===================== Table Card (hidden until Search) ===================== -->
  <!-- ===================== Table Card (show empty state at first) ===================== -->
  <div id="resultCard" class="card shadow-sm border-0">

    <!-- Header / Actions -->
    <div class="card-body pb-2">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-danger">
            <i class="fa-solid fa-ban me-2"></i>Cancel
          </button>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button id="btnExport" type="button" class="btn btn-success">
            <i class="fa-solid fa-file-excel me-2"></i>Export
          </button>
        </div>
      </div>
    </div>

    <!-- ✅ Empty state (เหมือนหน้า Import File) -->
    <div id="emptyState" class="card-body text-center py-5" th:classappend="${showResults} ? ' d-none' : ''">
      <div class="text-muted">
        <i class="fa-regular fa-file-lines me-2"></i>
        No data
      </div>
    </div>

    <!-- ✅ Table section (ซ่อนตอนเข้าใหม่) -->
    <div id="tableSection" th:classappend="${showResults} ? '' : ' d-none'">

      <!-- Table (no padding / no white gap) -->
      <div class="card-body p-0">
        <div class="customer-table-scroll">
          <table class="table table-bordered table-hover align-middle mb-0 customer-table" id="customerTable">
            <thead class="table-light">
              <tr>
                <th class="col-check text-center sticky-col-1">
                  <input id="chkAll" class="form-check-input" type="checkbox" aria-label="Select all">
                </th>
                <th>Customer ID</th>
                <th>Customer Name</th>
                <th>Job Status</th>
                <th>Appointment Date</th>
                <th>Survey Type</th>
                <th>Client Name</th>
                <th>OS Balance</th>
                <th>Agreement No.</th>
                <th>Created Date</th>
                <th>Updated Date</th>
                <th>Collector Result</th>
                <th>Collector Remark</th>
              </tr>
            </thead>

            <tbody id="tableBody">
              <!-- rows เดิมของคุณ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer (Total Rows) -->
      <div class="card-body pt-2">
        <div class="text-muted">Total Rows: <span id="totalRows">0</span></div>
      </div>

    </div><!-- /#tableSection -->
  </div><!-- /#resultCard -->

  <!-- ===================== Styles ===================== -->
  <style>
    /* Scroll wrapper ตัวเดียวพอ */
    .customer-table-scroll {
      position: relative;
      overflow: auto;
      max-height: 65vh;
      border-top: 1px solid rgba(0, 0, 0, .08);
    }

    /* table ต้อง separate เพื่อ sticky ทำงานนิ่ง */
    .customer-table {
      min-width: 1700px;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 0;
    }

    .col-check {
      width: 44px;
      min-width: 44px;
    }

    .col-cif {
      min-width: 140px;
    }

    .col-status {
      min-width: 220px;
    }

    /* กัน badge ถูกบีบ */

    /* ✅ บังคับเส้นตารางทุก cell (แก้ border หาย) */
    .customer-table th,
    .customer-table td {
      border-right: 1px solid #dee2e6 !important;
      border-bottom: 1px solid #dee2e6 !important;
      background-clip: padding-box;
    }

    /* เส้นซ้ายของตาราง */
    .customer-table tr>*:first-child {
      border-left: 1px solid #dee2e6 !important;
    }

    /* เส้นบนของหัวตาราง */
    .customer-table thead th {
      border-top: 1px solid #dee2e6 !important;
    }

    /* ===== Fix Header ===== */
    .customer-table thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: #f8f9fa;
    }

    /* ===== Sticky first columns ===== */
    .sticky-col-1 {
      position: sticky;
      left: 0;
      z-index: 6;
      background: #fff;
    }

    .sticky-col-2 {
      position: sticky;
      left: 44px;
      /* เท่ากับ col-check */
      z-index: 6;
      background: #fff;
    }

    /* header ของ sticky ต้องอยู่เหนือ */
    .customer-table thead .sticky-col-1,
    .customer-table thead .sticky-col-2 {
      z-index: 7;
      background: #f8f9fa;
    }

    /* ✅ ทำเส้นขวาของ sticky ชัด (ไม่ให้ดูเหมือนหาย) */
    .sticky-col-1,
    .sticky-col-2 {
      box-shadow: 1px 0 0 #dee2e6;
    }

    /* Job badge */
    .job-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      padding: .45rem .7rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: .875rem;
    }

    /* highlight row */
    tr.is-selected td {
      background: #fff3cd !important;
    }

    tr.is-selected td.sticky-col-1,
    tr.is-selected td.sticky-col-2 {
      background: #fff3cd !important;
    }
  </style>

  <!-- ===================== Scripts ===================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const emptyState = document.getElementById('emptyState');
      const tableSection = document.getElementById('tableSection');
      const tableBody = document.getElementById('tableBody');
      const totalRowsEl = document.getElementById('totalRows');

      // ====== sample data (10 rows) ======
      const SAMPLE_ROWS = [
        { cif: 'CIF0000001', name: 'John A', status: '0' },
        { cif: 'CIF0000002', name: 'John B', status: '1' },
        { cif: 'CIF0000003', name: 'John C', status: '5' },
        { cif: 'CIF0000004', name: 'John D', status: '6' },
        { cif: 'CIF0000005', name: 'John E', status: '98' },
        { cif: 'CIF0000006', name: 'John F', status: '99' },
        { cif: 'CIF0000007', name: 'John G', status: '0' },
        { cif: 'CIF0000008', name: 'John H', status: '1' },
        { cif: 'CIF0000009', name: 'John I', status: '5' },
        { cif: 'CIF0000010', name: 'John J', status: '6' },
      ];

      // ====== job status label + badge class mapping ======
      const statusMap = {
        "1": { text: "Draft", cls: "bg-warning" },
        "2": { text: "Sending", cls: "bg-primary" },
        "4": { text: "Sending", cls: "bg-primary" },
        "5": { text: "Send PDA", cls: "bg-info" },
        "6": { text: "Completed", cls: "bg-success" },
        "98": { text: "MCI Cancel", cls: "bg-dark" },
        "99": { text: "Cancel", cls: "bg-danger" },
      };

      function showEmpty() {
        tableSection?.classList.add('d-none');
        emptyState?.classList.remove('d-none');
        if (totalRowsEl) totalRowsEl.textContent = '0';
      }

      function showTable() {
        emptyState?.classList.add('d-none');
        tableSection?.classList.remove('d-none');
      }

      function applyBadges() {
        document.querySelectorAll('.js-job-status').forEach(el => {
          const s = el.dataset.status || '';
          const m = statusMap[s] || { text: s, cls: "bg-light text-dark" };
          el.textContent = m.text;
          el.className = `badge job-badge js-job-status ${m.cls}`; // reset class ให้ชัวร์
          el.dataset.status = s;
        });
      }

      function updateTotalRows() {
        if (!totalRowsEl) return;
        const visible = Array.from(document.querySelectorAll('#tableBody tr'))
          .filter(tr => tr.style.display !== 'none');
        totalRowsEl.textContent = String(visible.length);
      }

      function wireCheckbox() {
        const chkAll = document.getElementById('chkAll');

        function syncRow(tr) {
          const chk = tr.querySelector('.row-check');
          if (!chk) return;
          tr.classList.toggle('is-selected', chk.checked);
        }

        document.querySelectorAll('.row-check').forEach(chk => {
          chk.addEventListener('change', () => syncRow(chk.closest('tr')));
        });

        if (chkAll) {
          chkAll.addEventListener('change', () => {
            const checked = chkAll.checked;
            document.querySelectorAll('#tableBody tr').forEach(tr => {
              if (tr.style.display === 'none') return; // ไม่เลือกแถวที่ถูก filter ซ่อน
              const chk = tr.querySelector('.row-check');
              if (!chk) return;
              chk.checked = checked;
              syncRow(tr);
            });
          });
        }
      }

      // ====== render rows (สร้าง html 20 cols) ======
      function renderRows(data) {
        if (!tableBody) return;
        tableBody.innerHTML = data.map((r, idx) => {
          // สร้าง Col 4-20 เป็นตัวอย่าง
          const cols = [];
          for (let c = 4; c <= 13; c++) {
            cols.push(`<td>Data ${c}-${idx + 1}</td>`);
          }

          return `
        <tr data-cif="${r.cif}" data-name="${r.name}" data-status="${r.status}">
          <td class="text-center sticky-col-1">
            <input class="form-check-input row-check" type="checkbox">
          </td>
          <td class="fw-semibold sticky-col-2">${r.cif}</td>
          <td><span class="badge job-badge js-job-status" data-status="${r.status}"></span></td>
          ${cols.join('')}
        </tr>
      `;
        }).join('');

        applyBadges();
        wireCheckbox();
      }

      // ====== filter ======
      function doFilter() {
        const cif = (document.getElementById('txtCif')?.value || '').trim().toLowerCase();
        const name = (document.getElementById('txtCustName')?.value || '').trim().toLowerCase();
        const status = (document.getElementById('ddlJobStatus')?.value || '').trim();

        // ✅ ถ้ายังไม่มีข้อมูลในตาราง ให้สร้าง sample ก่อน
        if (tableBody && tableBody.children.length === 0) {
          renderRows(SAMPLE_ROWS);
        }

        // แล้วค่อย filter
        document.querySelectorAll('#tableBody tr').forEach(tr => {
          const rcif = (tr.dataset.cif || '').toLowerCase();
          const rname = (tr.dataset.name || '').toLowerCase();
          const rstatus = (tr.dataset.status || '');

          const okCif = !cif || rcif.includes(cif);
          const okName = !name || rname.includes(name);
          const okStatus = !status || rstatus === status;

          tr.style.display = (okCif && okName && okStatus) ? '' : 'none';
          // reset highlight เมื่อ filter
          tr.classList.remove('is-selected');
          const chk = tr.querySelector('.row-check');
          if (chk) chk.checked = false;
        });

        const chkAll = document.getElementById('chkAll');
        if (chkAll) chkAll.checked = false;

        showTable();
        updateTotalRows();
      }

      // submit search
      const form = document.getElementById('searchForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          doFilter();
        });
      }

      // reset
      const btnReset = document.getElementById('btnReset');
      if (btnReset) {
        btnReset.addEventListener('click', () => {
          document.getElementById('txtCif').value = '';
          document.getElementById('txtCustName').value = '';
          document.getElementById('ddlJobStatus').value = '';
          // กลับไป empty state เหมือนหน้า Import
          if (tableBody) tableBody.innerHTML = '';
          showEmpty();
        });
      }

      // initial
      showEmpty();
    });
  </script>

</div>